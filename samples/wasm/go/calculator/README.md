# Go WASM app

Used tinygo 0.29 in combination with go 1.21 and binaryen 114 on Windows 11

wasmtime version 12.0.1

I use a Powershell prompt on Windows 11

See [Tinygo](https://tinygo.org/)

Go 1.12 introduces WASI support, but suffers from lack of export, i.e. you can
currently only have WASM / WASI with a `main` function.

The wasm file generated by tinygo is in fact a wasi file regardless of the target
as it imports `fd_write` from `wasi_unstable` as this is used by the tinygo runtime.

## How to build

This contains instructions for both `tinygo` and `go`

This is primarily for me to compare where the two compilers are at when it comes to
WASM and WASI support.

### Using tinygo

```Powershell
PS> tinygo build -o .\calculator-in-go.wasm -target wasm .\calculator.go
```

### Using go

#### JavaScript + WASM

Building as JavaScript WASM:

```Powershell
PS> $Env:GOOS="js"
PS> $Env:GOARCH="wasm"
PS> go build -o calculator-in-go.wasm .\calculator.go
```

go 1.21 does not support export so `add` and `subtract` are not exported.

The wasm file cannot be used with wasmtime because it requires 8 imports.

#### WASI + WASM

Building as WASI:

```Powershell
PS> $Env:GOOS="wasip1"
PS> $Env:GOARCH="wasm"
PS> go build -o calculator-in-go.wasm .\calculator.go
```

go 1.21 does not support export so `add` and `subtract` are not exported.

The wasm file cannot be used with wasmtime because it requires 10 imports.

## Calling module

Call module:

```Powershell
PS> wasmtime calculator-in-go.wasm --invoke add 41 1
PS> wasmtime calculator-in-go.wasm --invoke subtract 41 1
```

